//@version=5
strategy("NIFTY50 EMA + Supertrend Strategy v4", overlay=true,
     initial_capital=1000000,
     commission_type=strategy.commission.percent,
     commission_value=0.02,
     slippage=2)

// ─────────────────────────────────────
// INPUTS
// ─────────────────────────────────────
emaFastLen  = input.int(20,   "Fast EMA")
emaSlowLen  = input.int(50,   "Slow EMA")
emaTrendLen = input.int(200,  "Trend EMA")
rsiLen      = input.int(14,   "RSI Length")
atrLen      = input.int(14,   "ATR Length")
atrSLMult   = input.float(1.5, "ATR SL Multiplier", step=0.1)
atrTPMult   = input.float(2.5, "ATR TP Multiplier", step=0.1)

// Supertrend Inputs
stAtrPeriod = input.int(10,   "Supertrend ATR Period")
stMultiplier = input.float(3.0, "Supertrend Multiplier", step=0.1)

// ─────────────────────────────────────
// EMA INDICATORS
// ─────────────────────────────────────
emaFast  = ta.ema(close, emaFastLen)
emaSlow  = ta.ema(close, emaSlowLen)
emaTrend = ta.ema(close, emaTrendLen)
rsi      = ta.rsi(close, rsiLen)
atr      = ta.atr(atrLen)

// ─────────────────────────────────────
// SUPERTREND CALCULATION (v5 native)
// ─────────────────────────────────────
[stLine, stDirection] = ta.supertrend(stMultiplier, stAtrPeriod)
// stDirection: -1 = uptrend (bullish), +1 = downtrend (bearish)
stBull = stDirection < 0   // supertrend is bullish
stBear = stDirection > 0   // supertrend is bearish

// ─────────────────────────────────────
// HIGHER TIMEFRAME DAILY BIAS
// ─────────────────────────────────────
emaFastHTF = request.security(syminfo.tickerid, "D", ta.ema(close, 20))
emaSlowHTF = request.security(syminfo.tickerid, "D", ta.ema(close, 50))
htfBullBias = emaFastHTF > emaSlowHTF
htfBearBias = emaFastHTF < emaSlowHTF

// ─────────────────────────────────────
// CONDITIONS
// ─────────────────────────────────────
noPosition = strategy.position_size == 0

bullTrend = close > emaTrend
bearTrend = close < emaTrend

bullCross = ta.crossover(emaFast, emaSlow)
bearCross = ta.crossunder(emaFast, emaSlow)

// ✅ All 3 must agree: EMA cross + Supertrend + Daily bias
bullSignal = bullCross and rsi > 52 and bullTrend and stBull and htfBullBias
bearSignal = bearCross and rsi < 48 and bearTrend and stBear and htfBearBias

// ─────────────────────────────────────
// ORDERS
// ─────────────────────────────────────
if bullSignal and noPosition
    strategy.entry("Long", strategy.long)

if strategy.position_size > 0
    strategy.exit("Long Exit", "Long",
         stop  = strategy.position_avg_price - atrSLMult * atr,
         limit = strategy.position_avg_price + atrTPMult * atr)

if bearSignal and noPosition
    strategy.entry("Short", strategy.short)

if strategy.position_size < 0
    strategy.exit("Short Exit", "Short",
         stop  = strategy.position_avg_price + atrSLMult * atr,
         limit = strategy.position_avg_price - atrTPMult * atr)

// ─────────────────────────────────────
// PLOTTING
// ─────────────────────────────────────
plot(emaFast,  "EMA 20",  color=color.yellow)
plot(emaSlow,  "EMA 50",  color=color.orange)
plot(emaTrend, "EMA 200", color=color.blue, linewidth=2)

// Supertrend line
plot(stBull ? stLine : na, "Supertrend Up",   color=color.green, linewidth=2, style=plot.style_linebr)
plot(stBear ? stLine : na, "Supertrend Down", color=color.red,   linewidth=2, style=plot.style_linebr)

// Background: daily bias
bgcolor(htfBullBias ? color.new(color.green, 97) : color.new(color.red, 97), title="Daily Bias")

// Entry signals
plotshape(bullSignal and noPosition, "Buy",  shape.triangleup,   location.belowbar, color.lime,  size=size.small)
plotshape(bearSignal and noPosition, "Sell", shape.triangledown,  location.abovebar, color.red,   size=size.small)